<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Star Citizen Gun Customizer</title>
<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  height: 100vh;
  margin: 0;
  background-color: #1c1c1c;
  color: #f0f0f0;
}
.panel { padding: 20px; overflow-y: auto; }
.guns-panel { width: 25%; background-color: #2c2c2c; border-right: 2px solid #444; }
.attachments-panel { width: 25%; background-color: #2c2c2c; border-left: 2px solid #444; }
.center-panel {
  flex-grow: 1; text-align: center; padding: 40px;
  display: flex; flex-direction: column; justify-content: flex-start; align-items: center;
}
h2 { margin-top: 0; }
button, select, input {
  margin: 5px 0; padding: 5px; border-radius: 4px; border: 1px solid #555;
  background-color: #3c3c3c; color: #f0f0f0;
}
button:hover { background-color: #5c5c5c; cursor: pointer; }
.gun-item, .attachment-item {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #444;
}
input[type="number"] { width: 50px; }
img.gun-img { max-width: 250px; max-height: 250px; border-radius: 8px; margin-bottom: 10px; }
.selected-gun-name { font-size: 24px; margin-bottom: 20px; }
.attachments-list p { margin: 5px 0; }

/* Scrollable attachment lists */
.attachment-scroll {
  max-height: 150px;
  overflow-y: auto;
  border: 1px solid #555;
  padding: 5px;
  margin-bottom: 10px;
  background-color: #2c2c2c;
  border-radius: 4px;
}
</style>
</head>
<body>

<div class="panel guns-panel">
  <h2>Guns</h2>
  <div id="gunsList"></div>

  <h3>Add Gun</h3>
  <input type="text" id="gunName" placeholder="Gun Name"><br>
  Barrel Size: <input type="number" id="gunBarrel" min="1" max="3"><br>
  Under Barrel Size: <input type="number" id="gunUnder" min="1" max="3"><br>
  Scope Size: <input type="number" id="gunScope" min="1" max="3"><br>
  Image URL (optional): <input type="text" id="gunImage" placeholder="http://..."><br>
  <button onclick="addGun()">Add Gun</button>

  <h3>Export / Import</h3>
  <button onclick="exportData()">Export JSON</button>
  <input type="file" id="importFile" onchange="importData(event)">
</div>

<div class="center-panel">
  <img id="selectedGunImage" src="" alt="" class="gun-img" style="display:none">
  <div class="selected-gun-name" id="selectedGunName">Select a Gun</div>
  <div class="attachments-list" id="selectedAttachments">
    <p>Barrel: None</p>
    <p>Under Barrel: None</p>
    <p>Scope: None</p>
  </div>
  <div>
    <button onclick="removeSelectedGun()">Delete Gun</button>
    <button onclick="deselectGun()">Deselect Gun</button>
  </div>
</div>

<div class="panel attachments-panel">
  <h2>Attachments</h2>
  
  <h3>Barrels</h3>
  <div id="barrelList" class="attachment-scroll"></div>
  <input type="text" id="barrelName" placeholder="Barrel Name">
  <input type="number" id="barrelSize" min="1" max="3">
  <button onclick="addAttachment('barrel')">Add Barrel</button>
  
  <h3>Under Barrels</h3>
  <div id="underList" class="attachment-scroll"></div>
  <input type="text" id="underName" placeholder="Under Barrel Name">
  <input type="number" id="underSize" min="1" max="3">
  <button onclick="addAttachment('under')">Add Under Barrel</button>
  
  <h3>Scopes</h3>
  <div id="scopeList" class="attachment-scroll"></div>
  <input type="text" id="scopeName" placeholder="Scope Name">
  <input type="number" id="scopeSize" min="1" max="3">
  <button onclick="addAttachment('scope')">Add Scope</button>
</div>

<script>
let guns = [], barrels = [], underBarrels = [], scopes = [];
let selectedGunIndex = null;

function saveToCookies() {
  const data = { guns, barrels, underBarrels, scopes, selectedGunIndex };
  document.cookie = "gunData=" + encodeURIComponent(JSON.stringify(data)) + ";path=/;max-age=31536000";
}

function loadFromCookies() {
  const cookies = document.cookie.split('; ').reduce((acc, c) => {
    const [k,v] = c.split('='); acc[k] = v; return acc;
  }, {});
  if(cookies.gunData) {
    try {
      const data = JSON.parse(decodeURIComponent(cookies.gunData));
      guns = data.guns || [];
      barrels = data.barrels || [];
      underBarrels = data.underBarrels || [];
      scopes = data.scopes || [];
      selectedGunIndex = data.selectedGunIndex || null;
    } catch(e) { console.warn("Failed to load cookies"); }
  }
}

function makeDraggableList(listEl, array) {
  let draggedIndex = null;
  listEl.addEventListener('dragstart', e => {
    draggedIndex = [...listEl.children].indexOf(e.target);
    e.dataTransfer.effectAllowed = 'move';
  });
  listEl.addEventListener('dragover', e => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  });
  listEl.addEventListener('drop', e => {
    e.preventDefault();
    const targetIndex = [...listEl.children].indexOf(e.target.closest('.gun-item, .attachment-item'));
    if (draggedIndex === null || targetIndex === -1) return;
    const [moved] = array.splice(draggedIndex, 1);
    array.splice(targetIndex, 0, moved);
    renderGuns();
    renderAttachments();
    draggedIndex = null;
  });
}

function renderGuns() {
  const list = document.getElementById('gunsList');
  list.innerHTML = '';
  guns.forEach((gun, index) => {
    const div = document.createElement('div');
    div.className = 'gun-item';
    div.setAttribute('draggable','true');
    div.innerHTML = `
      <span style="display:flex; align-items:center; cursor:pointer;">
        ${gun.image ? `<img class="gun-img" src="${gun.image}" alt="gun" style="width:30px;height:30px;margin-right:5px;">` : ''}
        ${gun.name}
      </span>
      <div>
        <button onclick="selectGun(${index})">Add</button>
        <button onclick="deleteGun(${index})">Delete</button>
      </div>
    `;
    list.appendChild(div);
  });
  makeDraggableList(list, guns);
  saveToCookies();
}

function renderAttachments() {
  function renderList(items, containerId, type) {
    const list = document.getElementById(containerId);
    list.innerHTML = '';
    items.forEach((item, i) => {
      const div = document.createElement('div');
      div.className = 'attachment-item';
      div.setAttribute('draggable','true');
      div.innerHTML = `
        ${item.name} (Size ${item.size})
        <div>
          <button onclick="attachToGun('${type}', ${i})">Add</button>
          <button onclick="deleteAttachment('${type}', ${i})">Delete</button>
        </div>
      `;
      list.appendChild(div);
    });
    makeDraggableList(list, items);
  }
  renderList(barrels, 'barrelList', 'barrel');
  renderList(underBarrels, 'underList', 'under');
  renderList(scopes, 'scopeList', 'scope');
  saveToCookies();
}

function renderSelectedGun() {
  const nameEl = document.getElementById('selectedGunName');
  const imgEl = document.getElementById('selectedGunImage');
  const attachEl = document.getElementById('selectedAttachments');
  if (selectedGunIndex === null) {
    imgEl.style.display = 'none';
    nameEl.innerText = 'Select a Gun';
    attachEl.innerHTML = `<p>Barrel: None</p><p>Under Barrel: None</p><p>Scope: None</p>`;
  } else {
    const gun = guns[selectedGunIndex];
    if (gun.image) { imgEl.src = gun.image; imgEl.style.display='block'; } else imgEl.style.display='none';
    nameEl.innerText = gun.name;
    attachEl.innerHTML = `
      <p>Barrel (Required Size ${gun.barrelSize}): ${gun.barrel ? gun.barrel.name : 'None'} <button onclick="removeAttachment('barrel')">Remove</button></p>
      <p>Under Barrel (Required Size ${gun.underSize}): ${gun.under ? gun.under.name : 'None'} <button onclick="removeAttachment('under')">Remove</button></p>
      <p>Scope (Required Size ${gun.scopeSize}): ${gun.scope ? gun.scope.name : 'None'} <button onclick="removeAttachment('scope')">Remove</button></p>
    `;
  }
  saveToCookies();
}

function addGun() {
  const nameEl = document.getElementById('gunName');
  const barrelEl = document.getElementById('gunBarrel');
  const underEl = document.getElementById('gunUnder');
  const scopeEl = document.getElementById('gunScope');
  const imageEl = document.getElementById('gunImage');

  const name = nameEl.value.trim();
  const barrel = parseInt(barrelEl.value);
  const under = parseInt(underEl.value);
  const scope = parseInt(scopeEl.value);
  const image = imageEl.value;
  if (!name || !barrel || !under || !scope) return alert("All fields except image required");
  if (guns.some(g => g.name.toLowerCase() === name.toLowerCase())) return alert("A gun with that name already exists!");
  guns.push({ name, barrelSize: barrel, underSize: under, scopeSize: scope, barrel: null, under: null, scope: null, image });
  renderGuns();

  // clear fields
  nameEl.value = ''; barrelEl.value = ''; underEl.value = ''; scopeEl.value = ''; imageEl.value = '';
}

function selectGun(index) { selectedGunIndex = index; renderSelectedGun(); }
function deleteGun(index){ if(selectedGunIndex===index) selectedGunIndex=null; guns.splice(index,1); renderGuns(); renderSelectedGun(); }
function removeSelectedGun(){ if(selectedGunIndex!==null){ guns.splice(selectedGunIndex,1); selectedGunIndex=null; renderGuns(); renderSelectedGun(); } }
function deselectGun(){ selectedGunIndex = null; renderSelectedGun(); }

function addAttachment(type) {
  const nameEl = document.getElementById(`${type}Name`);
  const sizeEl = document.getElementById(`${type}Size`);
  const name = nameEl.value.trim();
  const size = parseInt(sizeEl.value);
  if (!name || !size) return alert("All fields required");
  let arr = type==='barrel'?barrels:type==='under'?underBarrels:scopes;
  if (arr.some(a => a.name.toLowerCase()===name.toLowerCase())) return alert(`An attachment of type ${type} with that name already exists!`);
  arr.push({ name, size });
  renderAttachments();

  // clear fields
  nameEl.value = ''; sizeEl.value = '';
}

function deleteAttachment(type,index){
  let arr;
  if(type==='barrel') arr = barrels;
  if(type==='under') arr = underBarrels;
  if(type==='scope') arr = scopes;

  const removed = arr[index];
  arr.splice(index,1);

  // also remove from currently selected gun if in use
  if(selectedGunIndex!==null){
    const gun = guns[selectedGunIndex];
    if(gun[type] && gun[type].name === removed.name){
      gun[type] = null;
    }
  }

  renderAttachments();
  renderSelectedGun();
}

function removeAttachment(type){ if(selectedGunIndex===null) return; guns[selectedGunIndex][type]=null; renderSelectedGun(); }
function attachToGun(type,index){
  if(selectedGunIndex===null) return alert("Select a gun first");
  const gun=guns[selectedGunIndex];
  let attachment = type==='barrel'?barrels[index]:type==='under'?underBarrels[index]:scopes[index];
  const requiredSize = type==='barrel'?gun.barrelSize:type==='under'?gun.underSize:gun.scopeSize;
  if(attachment.size > requiredSize) return alert(`Size mismatch! Gun requires size ${requiredSize} or smaller. This attachment is size ${attachment.size}.`);
  gun[type]=attachment; renderSelectedGun();
}

function exportData(){ const data={guns,barrels,underBarrels,scopes}; const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='guns_attachments.json'; a.click(); URL.revokeObjectURL(url);}
function importData(event){
  const file=event.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const data=JSON.parse(e.target.result);
      guns=data.guns||[]; barrels=data.barrels||[]; underBarrels=data.underBarrels||[]; scopes=data.scopes||[];
      selectedGunIndex=null; renderGuns(); renderAttachments(); renderSelectedGun();
    }catch(e){ alert("Invalid JSON file"); }
  };
  reader.readAsText(file);
}

loadFromCookies();
renderGuns(); renderAttachments(); renderSelectedGun();
</script>
</body>
</html>
